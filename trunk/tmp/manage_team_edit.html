<!--{include manage_header}-->

<div id="bdw" class="bdw">
<div id="bd" class="cf">
<div id="leader">
	<div class="dashboard" id="dashboard">
		<ul>${mcurrent_team('team')}</ul>
	</div>
	<div id="content" class="clear mainwide">
        <div class="clear box">
            <div class="box-top"></div>
            <div class="box-content">
                <div class="head">
					<h2>编辑</h2>（*号表示清结算内合同定义信息）
					<div class="wholetip clear"><h3>（{$team['title']}）</h3></div>
				</div>
                <div class="sect">
				<form id="edit-team-form" method="post" action="/manage/team/edit.php?id={$team['id']}" onsubmit="return teamCheck();" enctype="multipart/form-data" class="validator">
					<input type="hidden" name="id" value="{$team['id']}" />
					<div class="wholetip clear"><h3>1、基本信息</h3></div>
					<div class="field">
						<label>清结算合同id</label>
						<!--{if ($team['begin_time'] > $now)}-->
							<select name="contract_id" id="team-create-contract-id" >
								<option value=""></option>
								<!--{loop $contract_list $index $contract}-->
								<option value="{$contract['CONTRACT_ID']}" <?php if($team['contract_id']==$contract['CONTRACT_ID']) echo 'selected';?> >{$contract['BUSI_NAME']}</option>
								<!--{/loop}-->
							</select>
						<!--{else}-->
							{$team['contract_id']}<!--{loop $contract_list $index $contract}--><!--{if ($team['contract_id']==$contract['CONTRACT_ID'])}-->({$contract['BUSI_NAME']})<!--{/if}--><!--{/loop}-->
						<!--{/if}-->
					</div>
					<div class="field">
						<label>*城市及分类</label>
						<select name="city_id" id="city_list" class="f-input" style="width:160px;">${Utility::Option(Utility::OptionArray($hotcities, 'id','name'), $team['city_id'], '')}</select><select name="group_id" class="f-input" style="width:160px;">${Utility::Option($groups, $team['group_id'])}</select><select name="conduser" class="f-input" style="width:160px;">${Utility::Option($option_cond, $team['conduser'])}</select>
					</div>
					<div class="field">
						<label>*团购标题</label>
						<input type="text" size="30" name="title" id="team-create-title" class="f-input" value="{$team['title']}" datatype="require" require="true" />
					</div>
					<div class="field">
						<label>wap团购标题</label>
						<input type="text" size="30" maxlength="16" name="wap_title" id="team-create-wap-title" class="f-input" value="{$team['wap_title']}" require="true" datatype="require" limitb="16"/>
						<span class="hint">最多16个字符</span>
					</div>
					<div class="field">
						<label>*市场价</label>
						<input type="text" size="10" name="market_price" id="team-create-market-price" class="number" value="${moneyit($team['market_price'])}" datatype="money" require="true" />
						<label>*团购价</label>
						<input type="text" size="10" name="team_price" id="team-create-team-price" class="number" value="${moneyit($team['team_price'])}" datatype="double" require="true" />
						<label>每人最少购买</label>
						<input type="text" size="10" name="per_min_number" id="team-create-per-min-number" class="number" value="${intval($team['per_min_number'])}" maxLength="6" datatype="number" require="true" />
						<span class="hint">团购价必须低于市场价，每人最少购买数量必须低于或等于每人限购数量</span>
					</div>
					<div class="field">
						<label>*最低数量</label>
						<input type="text" size="10" name="min_number" id="team-create-min-number" class="number" value="${intval($team['min_number'])}" maxLength="6" datatype="number" require="true" />
						<label>*最高数量</label>
						<input type="text" size="10" name="max_number" id="team-create-max-number" class="number" value="${intval($team['max_number'])}" maxLength="6" datatype="number" require="true" />
						<label>每人限购</label>
						<input type="text" size="10" name="per_number" id="team-create-per-number" class="number" value="${intval($team['per_number'])}" maxLength="6" datatype="number" require="true" />
						<span class="hint">最低数量必须大于0，最高数量/每日限购：0 表示没最高上限 （产品数|人数 由成团条件决定）</span>
					</div>
					<!-- <div class="field">
						<label>开始日期</label>
						<input type="text" size="10" name="begin_time" id="team-create-begin-time" class="date" value="${date('Y-m-d', $team['begin_time'])}" maxLength="10" />
						<label>结束日期</label>
						<input type="text" size="10" name="end_time" id="team-create-end-time" class="date" value="${date('Y-m-d', $team['end_time'])}" maxLength="10" />
						<label>券有效期</label>
						<input type="text" size="10" name="expire_time" id="team-create-expire-time" class="date" value="${date('Y-m-d', $team['expire_time'])}" maxLength="10" />
						<span class="hint">团购开始于开始日期00:00:00，结束于结束日期00:00:00</span>
					</div>
					-->
					<div class="field">
						<label>*开始日期</label>
						<input type="text" size="25" name="begin_time" style="float:left;margin:3px 15px 0 0;" id="team-create-begin-time" class="Wdate" value="${date('Y-m-d H:i', $team['begin_time'])}" onfocus="WdatePicker({dateFmt:'yyyy-MM-dd HH:mm'})" maxLength="20" />
						<label>*结束日期</label>
						<input type="text" size="25" name="end_time" id="team-create-end-time" style="float:left;margin:3px 15px 0 0;" class="Wdate" value="${date('Y-m-d H:i', $team['end_time'])}" onfocus="WdatePicker({dateFmt:'yyyy-MM-dd HH:mm'})" maxLength="20" />
						<!-- <span class="hint">团购开始于开始日期00:00:00，结束于结束日期00:00:00</span>  -->
					</div>
					<div class="field">
						<label>*券有效期</label>
						<input type="text" size="15" name="expire_time" id="team-create-expire-time" style="float:left;margin:3px 15px 0 0;" class="Wdate" value="${date('Y-m-d', $team['expire_time'])}" onfocus="WdatePicker()" maxLength="10" />
						<input type="hidden" id="today_date" value="{$today_date}" />
					</div>
					<div class="field">
						<label>*券生成规则</label>
						<select name="coupon_rule" id="team-create-coupon-rule" datatype="require" require="true">
							<option value="single"  >基于订单</option>
							<option value="multiple" <?php if($team['coupon_rule']=='multiple') echo 'selected';?>>基于订单购买数量</option>
						</select>
						<span class="hint">支付成功后生成的券规则，一条或多条</span>
					</div>
					<div class="field">
						<label>显示基数</label>
						<input type="text" size="10" name="cardinal_num" id="team-create-cardinal-num" class="number" value="${intval($team['cardinal_num'])}" maxLength="6" datatype="number" require="true" />
						<label>+实际购买量</label>
						<label> X 显示系数</label>
						<input type="text" size="3" name="modulus_num" id="team-create-modulus-num" class="number" value="${intval($team['modulus_num'])}" maxLength="3" datatype="number" require="true" />
						<label> = 显示数量</label>
					</div>
					<div class="field">
						<label>本团简介</label>
						<div style="float:left;"><textarea cols="45" rows="5" name="summary" id="team-create-summary" class="f-textarea" datatype="require" require="true">${htmlspecialchars($team['summary'])}</textarea></div>
					</div>
					<div class="field">
						<label>wap简介</label>
						<div style="float:left;"><textarea cols="45" rows="5" maxlength="160"  name="wap_summary" id="team-create-wap-summary" class="f-textarea" datatype="require" require="true" limitb="160">${htmlspecialchars($team['wap_summary'])}</textarea></div>
						<span class="hint">最多160个字符，图片大小请控制在166 X 100</span>
					</div>
					<div class="field">
						<label>特别提示</label>
						<div style="float:left;"><textarea cols="45" rows="5" name="notice" id="team-create-notice" class="f-textarea editor">{$team['notice']}</textarea></div>
						<span class="hint">关于本团标的有效期，使用说明</span>
					</div>
					<input type="hidden" name="guarantee" value="Y" />
					<input type="hidden" name="system" value="Y" />
					<div class="wholetip clear"><h3>2、团购标的物信息</h3></div>
					<div class="field">
						<label>商户</label>
						<input type="text" id="partner_name" disabled="disabled" class="f-input" value="{$partners[$team['partner_id']]}" size="30" onclick="document.getElementById('lmsh_partner_0').style.display='block';"/>
						<input type="hidden" name="partner_id" id="partner_id" value="{$team['partner_id']}"/>
						<input type="button" class="but_selectmerchant" value="选择商户" onclick="document.getElementById('lmsh_partner_0').style.display='block';"/>
					</div>
					<div id="lmsh_partner_0" style="position:relative; margin:0; float:left; clear:both;display:none;">
	                    <div style="position:absolute; padding:0 0 0 80px;">
	                      <iframe scrolling="no" frameborder="no" name="lmsh_partner_frame_0" id="lmsh_partner_frame_0" style="border:0;" width="665" height="159" src="/manage/team/partner0.php" ></iframe>
	                    </div>
                    </div>
					<div class="field">
                    	<label>关联商户</label>
                    	<input type="text" name="shop_name" id="shop_name" disabled="disabled" class="f-input" value="{$team['shop_name']}" size="30" onclick="document.getElementById('lmsh_partner').style.display='block';"/>
                    	<input type="hidden" name="shop_id" id="shop_id" value="{$team['shop_name']}^{$team['shop_id']}"/>
                    	<input name="" type="button" class="but_selectmerchant" value="选择商户" onclick="document.getElementById('lmsh_partner').style.display='block';"/>
                    	<span ><a href="http://www.12580777.com/lmshManage/" target="_blank">添加新商户</a></span>
                  </div>
	              <div id="lmsh_partner" style="position:relative; margin:0; float:left; clear:both;display:none;">
	                    <div style="position:absolute; padding:0 0 0 80px;">
	                      <iframe scrolling="no" frameborder="no" name="lmsh_partner_frame" id="lmsh_partner_frame" style="border:0;" width="665" height="159" src="/manage/team/partner.php" ></iframe>
	                    </div>
                  </div>
					<div class="field">
						<label>代金券使用</label>
						<input type="text" size="10" name="card" id="team-create-card" class="number" value="${moneyit($team['card'])}" require="true" datatype="money" />
						<span class="inputtip">可使用代金券最大面额</span>
					</div>
					<div class="field">
						<label>*商品名称</label>
						<input type="text" size="30" name="product" id="team-create-product" class="f-input" value="{$team['product']}" datatype="require" require="true" />
					</div>
					<div class="field">
						<label>商品图片</label>
						<input type="file" size="30" name="upload_image" id="team-create-image" class="f-input" />
						<!--{if $team['image']}--><span class="hint">${team_image($team['image'])}</span><!--{/if}-->
					</div>
					<div class="field">
						<label>商品图片1</label>
						<input type="file" size="30" name="upload_image1" id="team-create-image1" class="f-input" />
						<!--{if $team['image1']}--><span class="hint">${team_image($team['image1'])}</span><!--{/if}-->
					</div>
					<div class="field">
						<label>商品图片2</label>
						<input type="file" size="30" name="upload_image2" id="team-create-image2" class="f-input" />
						<!--{if $team['image2']}--><span class="hint">${team_image($team['image2'])}</span><!--{/if}-->
					</div>
					<div class="field">
						<label>wap商品图片</label>
						<input type="file" size="30" name="upload_image3" id="team-create-wap-image" class="f-input" />
						<!--{if $team['wap_image']}--><span class="hint">${team_image($team['wap_image'])} 图片大小为166*100</span><!--{/if}-->
					</div>
					<div class="field">
						<label>FLV视频短片</label>
						<input type="text" size="30" name="flv" id="team-create-flv" class="f-input" value="{$team['flv']}" />
						<span class="hint">形式如：http://.../video.flv</span>
					</div>
					<div class="field">
						<label>本单详情</label>
						<div style="float:left;"><textarea cols="45" rows="5" name="detail" id="team-create-detail" class="f-textarea editor">${htmlspecialchars($team['detail'])}</textarea></div>
					</div>
					<div class="field">
						<label>网友的点评</label>
						<div style="float:left;"><textarea cols="45" rows="5" name="userreview" id="team-create-userreview" class="f-textarea">${htmlspecialchars($team['userreview'])}</textarea></div>
						<span class="hint">格式："真好用|小兔|http://ww....|XXX网"，每行写一个点评</span>
					</div>
					<div class="field">
						<label>{$INI['system']['abbreviation']}推广辞</label>
						<div style="float:left;"><textarea cols="45" rows="5" name="systemreview" id="team-create-systemreview" class="f-textarea editor">${htmlspecialchars($team['systemreview'])}</textarea></div>
					</div>
					<div class="wholetip clear"><h3>3、配送信息</h3></div>
					<div class="field">
						<label>递送方式</label>
						<div style="margin-top:5px;" id="express-zone-div"><input type="radio" name="delivery" value="coupon" ${$team['delivery']=='coupon'?'checked':''} />&nbsp;{$INI['system']['couponname']}&nbsp;<input type="radio" name="delivery" value='express' ${$team['delivery']=='express'?'checked':''} />&nbsp;快递&nbsp;<input type="radio" name="delivery" value='pickup' ${$team['delivery']=='pickup'?'checked':''} />&nbsp;自取</div>
					</div>
					<div id="express-zone-coupon" style="display:${$team['delivery']=='coupon'?'block':'none'};">
						<div class="field">
							<label>消费返利</label>
							<input type="text" size="10" name="credit" id="team-create-credit" class="number" value="${moneyit($team['credit'])}" datatype="money" require="true" />
							<span class="inputtip">消费{$INI['system']['couponname']}时，获得账户余额返利，单位CNY元</span>
						</div>
					</div>
					<div id="express-zone-pickup" style="display:${$team['delivery']=='pickup'?'block':'none'};">
						<div class="field">
							<label>联系电话</label>
							<input type="text" size="10" name="mobile" id="team-create-mobile" class="f-input" value="{$team['mobile']}" />
						</div>
						<div class="field">
							<label>提货地址</label>
							<input type="text" size="10" name="address" id="team-create-address" class="f-input" value="{$team['address']}" />
						</div>
					</div>
					<div id="express-zone-express" style="display:${$team['delivery']=='express'?'block':'none'};">
						<div class="field">
							<label>快递费用</label>
							<input type="text" size="10" name="fare" id="team-create-fare" class="number" value="${intval($team['fare'])}" maxLength="6" datatype="money" require="true" />
							<span class="inputtip">市内快递费用，原则上3-10元之间</span>
						</div>
						<div class="field">
							<label>快递配送说明</label>
							<div style="float:left;"><textarea cols="45" rows="5" name="express" id="team-create-express" class="f-textarea">{$team['express']}</textarea></div>
						</div>
					</div>
					<input type="hidden" value="{$is_multi_team}" id="is_multi_team" name="is_multi_team" />
					<input type="hidden" value="{$other_city_idstr}" id="other_city_idstr" name="other_city_idstr" />
					<input type="hidden" value="1" id="submit_multi_flag" name="submit_multi_flag" />
					<input type="submit" value="好了，提交" name="commit" id="leader-submit" class="formbutton" style="margin:10px 0 0 120px;"/>
				</form>
                </div>
            </div>
            <div class="box-bottom"></div>
        </div>
	</div>

<div id="sidebar">
</div>

</div>
</div> <!-- bd end -->
</div> <!-- bdw end -->
<script type="text/javascript">
<!--

function teamCheck(){
	var flag=true;
	var other_city_idstr = document.getElementById('other_city_idstr').value;
	var city_id = document.getElementById('city_list').value;
	if(other_city_idstr != ""){
		var tmpArr = other_city_idstr.split(",");
		for(var i=0; i<tmpArr.length; i++){
			if(tmpArr[i] == city_id){
				alert("请选择其他城市，该团购城市重复");
				flag = false;
				break;
			}
		}
	}
	if(document.getElementById('partner_name').value==''||document.getElementById('partner_name').value=='点击此处选择商户') {
		alert('请选择商户');
		flag = false;
	}
	if(document.getElementById('shop_name').value==''||document.getElementById('shop_name').value=='点击此处选择商户') {
		alert('请选择关联商户');
		flag = false;
	}
	if(compareDate($("#team-create-begin-time").val(), $("#team-create-end-time").val()) > 0){
		alert('结束时间不得早于开始时间');
		flag = false;
	}
	if(compareDate($("#team-create-expire-time").val(), $("#today_date").val()) < 0){
		alert('券有效期不得早于当前日期！');
		flag = false;
	}
	if(parseInt(document.getElementById('team-create-per-min-number').value)>parseInt(document.getElementById('team-create-per-number').value)) {
		alert('每人最少购买数量必须低于或等于每人限购数量');
		flag = false;
	}
	if(parseFloat(document.getElementById('team-create-team-price').value)>=parseFloat(document.getElementById('team-create-market-price').value)) {
		alert('团购价必须低于市场价');
		flag = false;
	}
	if(flag == true && $("#is_multi_team").val() == 1){
		if(confirm("是否将修改同时保存在其他地市团购？")){
			$("#submit_multi_flag").val("1");
		}else{
			$("#submit_multi_flag").val("0");
		}
	}
	return flag;
}
try{
var cityList = ${json_encode($hotcities)};
var  contractList =${json_encode($contract_list)};
function addDate(dtTmp,strInterval, Number) {   
     switch (strInterval) {
         case 's' :return new Date(Date.parse(dtTmp) + (1000 * Number));  
         case 'n' :return new Date(Date.parse(dtTmp) + (60000 * Number));  
         case 'h' :return new Date(Date.parse(dtTmp) + (3600000 * Number));  
         case 'd' :return new Date(Date.parse(dtTmp) + (86400000 * Number));  
         case 'w' :return new Date(Date.parse(dtTmp) + ((86400000 * 7) * Number));  
         case 'q' :return new Date(dtTmp.getFullYear(), (dtTmp.getMonth()) + Number*3, dtTmp.getDate(), dtTmp.getHours(), dtTmp.getMinutes(), dtTmp.getSeconds());  
         case 'm' :return new Date(dtTmp.getFullYear(), (dtTmp.getMonth()) + Number, dtTmp.getDate(), dtTmp.getHours(), dtTmp.getMinutes(), dtTmp.getSeconds());  
         case 'y' :return new Date((dtTmp.getFullYear() + Number), dtTmp.getMonth(), dtTmp.getDate(), dtTmp.getHours(), dtTmp.getMinutes(), dtTmp.getSeconds());  
     }  
 }
  function dateFormat(myDate,format)
 {     
    var o = {     
      "M+" : myDate.getMonth()+1, //month     
      "d+" : myDate.getDate(),    //day     
      "h+" : myDate.getHours(),   //hour     
      "m+" : myDate.getMinutes(), //minute     
      "s+" : myDate.getSeconds(), //second     
      "q+" : Math.floor((myDate.getMonth()+3)/3), //quarter     
      "S" : myDate.getMilliseconds() //millisecond     
    }
    if(/(y+)/.test(format)) format=format.replace(RegExp.$1,(myDate.getFullYear()+"").substr(4 - RegExp.$1.length));     
    for(var k in o){
    	if(new RegExp("("+ k +")").test(format)){
      		format = format.replace(RegExp.$1,RegExp.$1.length==1?o[k]:("00"+ o[k]).substr((""+ o[k]).length));
      	}
     }     
    return format;
 }
$.fn.selInit = function(text){return $(this).html("<option value=''>"+text+"</option>");};
$("#team-create-contract-id").bind("change",function(){
	$("#team-create-coupon-rule").html("");
	var contractId = $("#team-create-contract-id option:selected").val();
	var contractName = $("#team-create-contract-id option:selected").text();
	if(contractId==""){
		$("#team-create-coupon-rule").append("<option value='single' >基于订单</option>");
 		$("#team-create-coupon-rule").append("<option value='multiple'>基于订单购买数量</option>");
 		$.each(cityList,function(p,x){
				$("#city_list").append("<option value='"+p+"' >"+x["name"]+"</option>");
		});
	}else{
		var BUSI_START_DATE = contractList[contractId]['BUSI_START_DATE'];//团购上线时间
		var BUSI_DUE_DATE   = contractList[contractId]['BUSI_DUE_DATE'];//团购下线时间      
		var SELL_NUM        = contractList[contractId]['SELL_NUM'];//团购最大数量
		var MIN_NUM         = contractList[contractId]['MIN_NUM'];//最低成团人数
		var GOODS_NAME      = contractList[contractId]['GOODS_NAME'];//商品名称
		var GOODS_DUE_DATE  = contractList[contractId]['GOODS_DUE_DATE'];//优惠券有效期
	 	var SELL_PRICE      = contractList[contractId]['SELL_PRICE'];//团购单价
	 	var MARKET_PRICE    = contractList[contractId]['MARKET_PRICE'];//市场价
	 	var AREA_NAME       = contractList[contractId]['AREA_NAME'];//地市名称
	 	var VALI_ROLE       = contractList[contractId]['VALI_ROLE'];//验证码下发规则      
	 	var SELL_CONTENT    = contractList[contractId]['SELL_CONTENT'];//团购内容
	 	
	 	if(contractId==""){
	 		$("#team-create-coupon-rule").append("<option value='single' >基于订单</option>");
	 		$("#team-create-coupon-rule").append("<option value='multiple'>基于订单购买数量</option>");
	 	}else if(VALI_ROLE=="multiple"){
	 		$("#team-create-coupon-rule").append("<option value='single' >基于订单</option>");
	 		$("#team-create-coupon-rule").append("<option value='multiple' selected>基于订单购买数量</option>");
	 	}else{
	 		$("#team-create-coupon-rule").append("<option value='single' selected>基于订单</option>");
	 		$("#team-create-coupon-rule").append("<option value='multiple' >基于订单购买数量</option>");
	 	}
	 	$("#city_list").html("");
	 	$.each(cityList,function(p,x){
	 		if(AREA_NAME && AREA_NAME.indexOf(x["name"])!=-1){
				$("#city_list").append("<option value='"+p+"' selected>"+x["name"]+"</option>");
			}else{
				$("#city_list").append("<option value='"+p+"' >"+x["name"]+"</option>");
			}
		});
		if(BUSI_START_DATE.length<16){
			$("#team-create-begin-time").val(BUSI_START_DATE.substring(0,4)+"-"+BUSI_START_DATE.substring(4,6)+"-"+BUSI_START_DATE.substring(6,8)+" "+BUSI_START_DATE.substring(8,10)+":"+BUSI_START_DATE.substring(10,12)+":"+BUSI_START_DATE.substring(12,14));
		}else{
			$("#team-create-begin-time").val(BUSI_START_DATE);
		}
		
		if(BUSI_DUE_DATE.length<16){
			$("#team-create-end-time").val(BUSI_DUE_DATE.substring(0,4)+"-"+BUSI_DUE_DATE.substring(4,6)+"-"+BUSI_DUE_DATE.substring(6,8)+" "+BUSI_DUE_DATE.substring(8,10)+":"+BUSI_DUE_DATE.substring(10,12)+":"+BUSI_DUE_DATE.substring(12,14));
		}else{
			$("#team-create-end-time").val(BUSI_DUE_DATE);
		}
		$("#team-create-min-number").val(MIN_NUM);
		$("#team-create-max-number").val(SELL_NUM);
		$("#team-create-product").val(GOODS_NAME);
		$("#team-create-expire-time").val(GOODS_DUE_DATE);
		$("#team-create-market-price").val(MARKET_PRICE);
		$("#team-create-team-price").val(SELL_PRICE);
		$("#team-create-title").val(SELL_CONTENT);
	}
	
});
}catch(e){}

function compareDate(date1, date2){
    if(date1 < date2){
    	return -1;
    }else if(date1 == date2){
    	return 0;
    }else{
    	return 1;
    }
}
//-->
</script>
<!--{include manage_footer}-->
